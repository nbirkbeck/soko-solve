var soko={constants:{}};soko.constants.CellTypes={WALL:0,EMPTY:1,CROSS:2};soko.constants.Directions={UP:0,DOWN:1,LEFT:2,RIGHT:3};soko.constants.BLOCK_SIZE=32;soko.constants.MAX_CANVAS_BLOCKS=12;soko.constants.DELTAS=[[0,-1],[0,1],[-1,0],[1,0]];soko.HeapInterface=function(){};soko.HeapInterface.prototype.size=function(){};soko.HeapInterface.prototype.empty=function(){};soko.HeapInterface.prototype.push=function(a,b){};soko.HeapInterface.prototype.pop=function(){};soko.Heap=function(){this.data_=[];this.map_={}};soko.Heap.prototype.size=function(){return this.data_.length};soko.Heap.prototype.empty=function(){return 0==this.data_.length};soko.Heap.prototype.push=function(a,b){var c=this.data_.length;this.data_[c]={score:b,value:a};this.map_[a.id]=c;this.siftUp_(c)};soko.Heap.prototype.pop=function(){this.swap_(0,this.data_.length-1);var a=this.data_[this.data_.length-1];this.data_.length--;this.map_[a.value.id]=void 0;this.siftDown_(0);return a};
soko.Heap.prototype.updateIfBetter=function(a,b){var c=this.map_[a.id];b<this.data_[c].score&&(this.data_[c].score=b,this.data_[c].value=a,this.siftUp_(c))};soko.Heap.prototype.exists=function(a){return void 0!==this.map_[a.id]};soko.Heap.prototype.siftDown_=function(a){for(var b=this.data_.length;2*a+1<b;){var c=2*a+1,d=2*a+2,e=d;if(d>=this.data_.length||this.data_[c].score<this.data_[d].score)e=c;if(this.data_[e].score<this.data_[a].score)this.swap_(e,a),a=e;else break}};
soko.Heap.prototype.siftUp_=function(a){for(;0<a;){var b=Math.floor((a-1)/2);if(this.data_[b].score>this.data_[a].score)this.swap_(b,a),a=b;else break}};soko.Heap.prototype.swap_=function(a,b){var c=this.data_[a];this.data_[a]=this.data_[b];this.data_[b]=c;this.map_[this.data_[a].value.id]=a;this.map_[this.data_[b].value.id]=b};soko.Level=function(a){this.grid=[];this.startPos=[];this.boxes=[];this.crosses=[];this.maxWidth=0;a&&this.loadLevel(a)};
soko.Level.prototype.loadLevel=function(a){a=a.split("\n");this.grid=[];this.startPos=[];this.boxes=[];this.crosses=[];for(var b=this.maxWidth=0;b<a.length;++b){var c=[];if(0!=a[b].length){for(var d=0;d<a[b].length;++d){c[d]=soko.constants.CellTypes.EMPTY;"#"==a[b][d]&&(c[d]=soko.constants.CellTypes.WALL);if("x"==a[b][d]||"%"==a[b][d]||"@"==a[b][d])c[d]=soko.constants.CellTypes.CROSS,this.crosses.push([d,b]);if("*"==a[b][d]||"@"==a[b][d])this.startPos=[d,b],this.pos=[d,b];("b"==a[b][d]||"%"==a[b][d])&&
this.boxes.push([d,b])}this.maxWidth=Math.max(this.maxWidth,c.length);this.grid[b]=c}}};
soko.Level.prototype.draw=function(a,b){var c=soko.constants.BLOCK_SIZE;b.setTransform(1,0,0,1,0,0);b.fillStyle="#FFF";b.fillRect(0,0,1E3,1E3);b.translate((soko.constants.MAX_CANVAS_BLOCKS-this.maxWidth)/2*c,(soko.constants.MAX_CANVAS_BLOCKS-this.grid.length)/2*c);for(var d=0;d<this.grid.length;++d)for(var e=0;e<this.grid[d].length;++e)this.grid[d][e]==soko.constants.CellTypes.WALL?(b.fillStyle="#444",b.strokeStyle="#000",b.fillRect(e*c,d*c,c,c),b.strokeRect(e*c,d*c,c,c)):this.grid[d][e]==soko.constants.CellTypes.CROSS?
(b.strokeWidth=6,b.strokeStyle="#0F0",b.beginPath(),b.moveTo(e*c,(d+1)*c),b.lineTo((e+1)*c,d*c),b.moveTo(e*c,d*c),b.lineTo((e+1)*c,(d+1)*c),b.stroke()):4<this.grid[d][e]&&(b.strokeWidth=2,b.strokeStyle="#F00",b.beginPath(),b.moveTo(e*c+8,(d+1)*c-8),b.lineTo((e+1)*c-8,d*c+8),b.stroke());for(d=0;d<a.boxes.length;++d)e=a.boxes[d],b.fillStyle="#AA0",b.fillRect(e[0]*c,e[1]*c,c,c);b.beginPath();b.arc((a.pos[0]+0.5)*c,(a.pos[1]+0.5)*c,c/2,0,2*Math.PI);b.stroke()};
soko.Level.prototype.move=function(a,b){var c=soko.constants.DELTAS[b],d=soko.math.vectorAdd(a.pos,c),c=soko.math.vectorAdd(a.pos,c,2),e=this.getCellType(d),f=this.getCellType(c),g=a.getBlockIndex(d),h=a.getBlockIndex(c);if(e>=soko.constants.CellTypes.EMPTY){if(0>g)return a.pos=d,!0;if(f>=soko.constants.CellTypes.EMPTY&&0>h)return a.pos=d,a.boxes[g]=c,!0}return!1};soko.Level.prototype.getCellType=function(a){if(0<=a[1]&&a[1]<this.grid.length)return this.grid[a[1]][a[0]]};
soko.Level.prototype.getNeighbors=function(a){for(var b=[],c=0;4>c;++c){var d=new soko.State(a.pos,a.boxes);this.move(d,c)&&b.push([1,d])}return b};
soko.Level.prototype.computeShortestPath=function(a,b){var c={},d=[],e=[a.pos[0],a.pos[1],1,[]];c[soko.State.pointToIndex(e)]=1;for(d.push(e);0<d.length;){e=d.shift();if(b&&e[0]==b[0]&&e[1]==b[1]){c=[];do c.push([e[0],e[1]]),e=e[3];while(3<e.length);break}for(var f=0;4>f;++f){var g=soko.constants.DELTAS[f],g=[g[0]+e[0],g[1]+e[1],1+e[2],e],h=this.getCellType(g),k=a.getBlockIndex(g);h>=soko.constants.CellTypes.EMPTY&&0>k&&(h=soko.State.pointToIndex(g),void 0===c[h]&&(c[h]=g[2],d.push(g)))}}return c};
soko.Level.prototype.getNeighborsCondensed=function(a){for(var b=[],c=this.computeShortestPath(a),d=0;d<a.boxes.length;++d)for(var e=a.boxes[d],f=0;4>f;++f){var g=soko.constants.DELTAS[f],h=soko.math.vectorAdd(e,g);if(!(this.getCellType(h)<soko.constants.CellTypes.EMPTY)&&!(0<=a.getBlockIndex(h))&&(g=soko.math.vectorAdd(e,g,-1),!(this.getCellType(g)<soko.constants.CellTypes.EMPTY))){var k=c[soko.State.pointToIndex(g)];if(void 0!==k){var m=new soko.State(e,a.boxes);m.boxes[d]=h;b.push([k,m,g])}}}return b};
soko.Level.prototype.isGoal=function(a){for(var b=0;b<a.boxes.length;++b)if(this.getCellType(a.boxes[b])!=soko.constants.CellTypes.CROSS)return!1;return!0};soko.Level.prototype.getInitialState=function(){return new soko.State(this.startPos,this.boxes)};soko.Level.prototype.createAbstraction=function(a,b){var c=new soko.Level;c.grid=this.grid;c.startPos=this.startPos;c.crosses=this.crosses;c.boxes=[];for(var d=a;d<b;d++)c.boxes.push(this.boxes[d].slice(0,2));return c};soko.Queue=function(){this.data_=[];this.map_=[]};soko.Queue.prototype.empty=function(){return 0==this.data_.length};soko.Queue.prototype.size=function(){return this.data_.length};soko.Queue.prototype.push=function(a,b){this.map_[a.id]=this.data_.length;this.data_.push([a,b])};soko.Queue.prototype.pop=function(){var a=this.data_.shift();this.map_[a[0].id]=void 0;return{value:a[0],score:a[1]}};soko.Queue.prototype.exists=function(a){return void 0!==this.map_[a.id]};
soko.Queue.prototype.updateIfBetter=function(a,b){};soko.types={};soko.math={};soko.math.vectorAdd=function(a,b,c){c=c||1;return[a[0]+b[0]*c,a[1]+b[1]*c]};soko.math.vectorDistanceL1=function(a,b){return Math.abs(a[0]-b[0])+Math.abs(a[1]-b[1])};soko.math.factorial=function(a){for(var b=1;1<a;)b*=a,--a;return b};soko.heuristic={};soko.heurisitc={};soko.heurisitc.SimplelHeuristic={};soko.heurisitc.AbstractHeuristic={};soko.heuristic.MAX_SCORE=1E4;
soko.heuristic.InvalidMap=function(a){this.map_={};for(var b=1;b<a.grid.length-1;++b)for(var c=1;c<a.grid[b].length-1;++c){var d=[c,b],e=a.getCellType(d);if(!(e==soko.constants.CellTypes.CROSS||e==soko.constants.CellTypes.WALL)){var e=soko.State.pointToIndex(d),f=a.getCellType([d[0],d[1]-1])==soko.constants.CellTypes.WALL,g=a.getCellType([d[0],d[1]+1])==soko.constants.CellTypes.WALL,h=a.getCellType([d[0]-1,d[1]])==soko.constants.CellTypes.WALL,k=a.getCellType([d[0]+1,d[1]])==soko.constants.CellTypes.WALL;
if((h||k)&&(f||g))this.map_[e]=!0;if((f||g)&&h)this.tryMarkLine_(a,d,0,[0,f?-1:1]);if((k||h)&&f)this.tryMarkLine_(a,d,1,[h?-1:1,0])}}};
soko.heuristic.InvalidMap.prototype.tryMarkLine_=function(a,b,c,d){for(var e=0==c?a.grid[b[1]].length-1:a.grid.length-1,f=[b[0],b[1]],g=b[c]+1;g<e;++g){f[c]=g;var h=a.getCellType(f);if(h==soko.constants.CellTypes.WALL){e=g;break}var k=soko.math.vectorAdd(f,d),k=a.getCellType(k)>=soko.constants.CellTypes.EMPTY;if(h==soko.constants.CellTypes.CROSS||k)return}f=[b[0],b[1]];for(g=b[c]+1;g<e;++g)f[c]=g,this.map_[soko.State.pointToIndex(f)]=!0};
soko.heuristic.InvalidMap.prototype.isInvalid=function(a){for(var b=0;b<a.boxes.length;++b)if(this.isInvalidPoint(a.boxes[b]))return!0;return!1};soko.heuristic.InvalidMap.prototype.isInvalidPoint=function(a){return this.map_[soko.State.pointToIndex(a)]};soko.heuristic.Heuristic=function(){};soko.heuristic.Heuristic.prototype.evaluate=function(a){};soko.heuristic.NullHeuristic=function(a){};soko.heuristic.NullHeuristic.prototype.evaluate=function(a){return 0};
soko.heuristic.SimpleHeuristic=function(a){this.level_=a;this.invalidMap_=new soko.heuristic.InvalidMap(a)};soko.heuristic.SimpleHeuristic.prototype.evaluate=function(a){for(var b=0,c=soko.heuristic.MAX_SCORE,d=this.level_,e=0;e<a.boxes.length;++e){for(var f=1E10,g=a.boxes[e],h=0,k=d.crosses.length;h<k;++h)f=Math.min(f,soko.math.vectorDistanceL1(d.crosses[h],g));b+=f;c=Math.min(soko.math.vectorDistanceL1(g,a.pos),c)}return b+Math.max(0,c-1)};
soko.heuristic.BetterHeuristic=function(a){this.level=a;this.invalidMap_=new soko.heuristic.InvalidMap(a)};
soko.heuristic.BetterHeuristic.prototype.evaluate=function(a){if(4<a.boxes.length)return 0;var b=soko.math.factorial(a.boxes.length),c=1E10;if(this.invalidMap_.isInvalid(a))return soko.heuristic.MAX_SCORE;for(var d=0;d<b;++d){for(var e=d,f=[],g=[],h=0,k=0;k<a.boxes.length;++k){for(var m=a.boxes.length-k,n=e%m,l=0;0<n||!0===f[l];)!0!==f[l]&&n--,l++;n=soko.math.vectorDistanceL1(this.level.crosses[l],a.boxes[k]);e=Math.floor(e/m);h+=n;f[l]=!0;g[k]=n}g=g.sort();for(l=0;l<g.length-1;++l)h+=g[l];c=Math.min(h,
c)}b=soko.heuristic.MAX_SCORE;for(d=0;d<a.boxes.length;++d)b=Math.min(soko.math.vectorDistanceL1(a.boxes[d],a.pos),b);return c+Math.max(0,b-1)};
soko.heuristic.AbstractHeuristic=function(a,b){this.level_=a;this.abstractLevels_=[];this.cache_={};this.abstractionSize_=b||1;for(var c=0;c<a.boxes.length;c+=this.abstractionSize_)this.abstractLevels_.push(a.createAbstraction(c,Math.min(a.boxes.length,c+this.abstractionSize_)));this.solver_=1==this.abstractionSize_?new soko.Solver(soko.heuristic.SimpleHeuristic,soko.Heap):new soko.Solver(soko.heuristic.AbstractHeuristic,soko.Heap)};
soko.heuristic.AbstractHeuristic.prototype.evaluate=function(a){for(var b=0,c=0;c<this.abstractLevels_.length;c++){var d=this.abstractionSize_*c,e=Math.min(a.boxes.length,d+this.abstractionSize_),f=a.createAbstraction(d,e),e=f.id(),d=this.cache_[e];if(void 0===d){f=this.solver_.solve(this.abstractLevels_[c],f);d=f.length-1;0>d&&(d=soko.heuristic.MAX_SCORE);this.cache_[e]=d;for(e=0;e<f.length;e++)this.cache_[f[e].id()]=e}b=Math.max(b,d)}return b};
soko.heuristic.MaxHeuristic=function(a){this.heuristics_=[new soko.heuristic.AbstractHeuristic(a),new soko.heuristic.AbstractHeuristic(a,2),new soko.heuristic.BetterHeuristic(a),new soko.heuristic.SimpleHeuristic(a)]};soko.heuristic.MaxHeuristic.prototype.evaluate=function(a){var b=0;this.heuristics_.forEach(function(c){b=Math.max(c.evaluate(a),b)});return b};soko.State=function(a,b){this.pos=[a[0],a[1]];this.boxes=b.map(function(a){return a})};soko.State.MAX_WIDTH=8;soko.State.NBITS=6;soko.State.pointToIndex=function(a){return(a[1]-1)*soko.State.MAX_WIDTH+(a[0]-1)};soko.State.prototype.createAbstraction=function(a,b){return new soko.State(this.pos,this.boxes.slice(a,b))};
soko.State.prototype.pack=function(){for(var a=this.boxes.sort(function(a,b){return soko.State.pointToIndex(b)-soko.State.pointToIndex(a)}),b=soko.State.pointToIndex(this.pos),c=Math.min(a.length,4),d=0;d<c;d++)b+=soko.State.pointToIndex(a[d])<<(d+1)*soko.State.NBITS;if(4>=a.length)return b;for(var e=b.toString(16),b=0,d=c;d<a.length;++d)b+=soko.State.pointToIndex(a[d])<<(d-c)*soko.State.NBITS;return e+","+b.toString(16)};
soko.State.prototype.getBlockIndex=function(a){for(var b=0;b<this.boxes.length;b++)if(this.boxes[b][0]==a[0]&&this.boxes[b][1]==a[1])return b;return-1};soko.State.prototype.id=function(){return this.pack()};soko.Solver=function(a,b,c){this.heuristicType_=a||soko.heuristic.NullHeuristic;this.heapType_=b||soko.Queue;this.condensed_=c||!1;this.print=!1;this.solverStats={elapsedTime:"",solutionLength:"",finalQueueSize:"",nodesVisited:""}};
soko.Solver.prototype.solve=function(a,b){var c=[],d=Date.now(),e=new this.heuristicType_(a),f={state:b,g:0,h:e.evaluate(b),parent:null,id:b.id()},g=new this.heapType_,h=0,k={},m=a.getNeighbors.bind(a),n=new soko.heuristic.InvalidMap(a);this.condensed_&&(m=a.getNeighborsCondensed.bind(a));for(g.push(f,f.h);!g.empty();){var l=g.pop(),f=l.value;this.print&&0==h%5E3&&console.log(l.score+" "+h+" "+g.size());if(0==h%2E4&&120<(Date.now()-d)/1E3)break;k[f.id]=!0;h++;if(a.isGoal(f.state)){c=this.backtrack_(a,
f);break}for(var l=m(f.state),p=0,v=l.length;p<v;++p){var q=l[p][1].id();if(!k[q]&&!n.isInvalid(l[p][1])){var r=l[p][1],s=f.g+l[p][0],t=e.evaluate(r),u=s+t,q={state:r,pusher:l[p][2],g:s,h:t,parent:f,id:q};g.exists(q)?g.updateIfBetter(q,u):g.push(q,u)}}}d=(Date.now()-d)/1E3;this.print&&console.log("numVisited:"+h+" duration:"+d);this.solverStats={solutionLength:c.length,elapsedTime:d,finalQueueSize:g.size(),nodesVisited:h};return c};
soko.Solver.prototype.backtrack_=function(a,b){var c=[];this.print&&console.log(b);do{var d=b.parent;if(null!=d&&b.pusher){var e=a.computeShortestPath(d.state,b.pusher);c.push(b.state);for(var f=0;f<e.length-1;f++){var g=new soko.State(e[f],d.state.boxes);c.push(g)}}else c.push(b.state);b=b.parent}while(null!=b);this.print&&console.log(c.length);return c};soko.levels={};soko.levels.microa="#######\n#*  bx#\n#   bx#\n#######\n;########\n#x     #\n#  bb x#\n#*     #\n########\n;####\n# x#\n#  ###\n#%*  #\n#  b #\n#  ###\n####\n;######\n#    #\n# #* #\n# b% #\n# x% #\n#    #\n######\n;  ####   \n###  ####\n#     b #\n# #  #b #\n# x x#* #\n#########\n;########\n#      #\n# x%%b*#\n#      #\n#####  #\n    ####\n; #######\n #     #\n # xbx #\n## b*b #\n#  xbx #\n#      #\n########\n;#######\n#     #\n# xbx #\n# bxb #\n# xbx #\n# bxb #\n#  *  #\n#######\n;  ######\n  # xx*#\n  # bb #\n  ## ###\n#### #\n#    ##\n# #   #\n#   # #\n###   #\n  #####\n;#####\n#x  ##\n#*bb #\n##   #\n ##  #\n  ##x#\n   ###\n;  ###### \n  #    # \n  # ##*##\n### # b #\n# xx# b #\n#       #\n#  ######\n####\n;#####\n#   ##\n# b  #\n## b ####\n ###*x  #\n  #  x# #\n  #     #\n  #######\n;####\n#x ##\n#x* #\n#x b#\n##b ###\n # b  #\n #    #\n #  ###\n ####;#######\n#     #\n# # # #\n#x b%*#\n#   ###\n#####  \n;     ### \n######*##\n#    x% #\n#   #   #\n#####b# #\n    #   #\n    #####\n; #### \n #  ####\n #     ##\n## ## * #\n#x x#  b##\n#   # bb #\n#  x#    #\n##########\n;#####\n# * #\n#xxx#\n#bbb##\n#    #\n#    #\n######;#######\n#     #\n#x x  #\n# ## ##\n#  b #\n###b #\n  #* #\n  #  #\n  ####\n;########\n#   xx #\n#  *bb #\n##### ##\n   #  #\n   #  #\n   #  #\n   ####;#######\n#*    ###\n#   bbxx#\n#### ## #\n  #     #\n  #  ####\n  #  #\n  ####\n;####\n#  ####\n# x x #\n# bb#*#\n##    #\n ######;#####\n#   ###\n#x x  #\n#   # #\n## #  #\n #*bb #\n #    #\n #  ###\n ####\n;#######\n#  %  #\n#     #\n## # ##\n #b*x#\n #   #\n #####\n;  #####\n  #   #\n###bb*#\n#   ###\n#     #\n# x x #\n#######\n; ####\n #  ###\n # bb #\n##xxx #\n#  *b #\n#   ###\n#####\n; #####\n # * #\n #   #\n###b #\n# xxx#\n# bb #\n###  #\n  ####\n;######\n#   x#\n# ## ##\n#  bb*#\n# #   #\n#x  ###\n#####\n;#####\n#   #\n# * #\n# bb###\n##x x #\n #    #\n ######\n;####\n#  ###\n# bb #\n#xxx #\n# *b #\n#   ##\n#####;  ####\n ##  #\n##*bx##\n# bb  #\n# x x #\n###   #\n  #####\n".split(";");soko.levels.microb=[];soko.levels.microc="  ####\n ##  #####\n #  b  * #\n #  b#   #\n#### #####\n#  #   #\n#    b #\n# xx#  #\n#  x####\n#  ##\n####;####\n#  #####\n# bb b #\n#      #\n## ## ##\n#xxx#*#\n# ### ##\n#      #\n#  #   #\n########\n; #######\n## xxxx#\n#   ######\n#   b b *#\n###  b b #\n  ###    #\n    ######\n; #####\n##   #\n#    #####\n#  #x#   #\n#* #x# b #\n#  #x#  ##\n#    #  #\n##  ##bb#\n ##     #\n  #  ####\n  ####\n; #########\n #    #  #\n## b#b#  #\n#  xbx*  #\n#  x#    #\n##########\n;####\n#  #######\n#  x ## x#\n# b#    x#\n## ## # x#\n #    #  #\n #### #  #\n  # *b ###\n  # bb #\n  #    #\n  ######; #####\n #   #\n # x #\n## % #\n#  %##\n#  *##\n## b #\n #   #\n #####\n;#####\n#   ###\n# x   ##\n##%#b  #\n# x# b #\n# *## ##\n#      #\n########\n;######  \n#    ##  \n# b b ## \n## bb  # \n # #   # \n # ## ## \n #  x x# \n # *x x# \n #  #### \n ####    \n;    #### \n  ###  ##\n ## b   #\n## b  # #\n# *#bb  #\n# xx  ###\n# xx###\n#####\n;     ####\n######  #\n#       #\n#  xxx x#\n##b######\n# b  #\n#   b###\n##  b  #\n ## *  #\n  ######\n;##########\n#   ##   #\n# b  b*# #\n#### # b #\n   #x#  ##\n   #x# b#\n   #x   #\n   #x   #\n   ######\n; ########\n #  *   #\n # b  b #\n### ## ###\n#  bxxb  #\n#   xx   #\n##########\n;#########\n# * #   #\n# b b   #\n##b### ##\n#  xxx  #\n#   #   #\n######  #\n     ####\n;########\n#*     #\n# xbbx #\n# bxxb #\n# bxxb #\n# xbbx #\n#      #\n########\n;#######\n# *#  #\n#xb   #\n#x # b##\n#xb#   #\n#x # b #\n#  #   #\n########\n;  #####\n  # x ##\n### b  #\n# x b#*#\n# #b x #\n#  b ###\n## x #\n #####\n;    #####\n#####   #\n#    b  #\n#  b#b#*#\n### #   #\n  # xxx #\n  ###  ##\n    #  #\n    ####\n; ########\n #      #\n #*   b #\n## ###b #\n# xxxxx###\n# b b b  #\n###### # #\n     #   #\n     #####\n;########\n#      #\n# b%%% #\n# %  % #\n# %  % #\n# %%%x #\n#     *#\n########\n;  ####\n  #  #\n  # b####\n###x x  #\n# b # b #\n#  x x###\n####b #\n   # *#\n   ####\n;######\n#    ####\n#    xxx#\n#    xxx#\n######  #\n  #  #  #\n  # bb ##\n  # *b  #\n  # bb  #\n  ## b# #\n   #    #\n   ######\n".split(";");soko.game={};soko.levelpacks=[{name:"microa",levels:soko.levels.microa},{name:"microc",levels:soko.levels.microc}];
soko.Game=function(){this.levelIndex=this.levelPackIndex=0;this.solution=void 0;this.nameEl=document.getElementById("name");this.resultsEl=document.getElementById("results");this.allResultsEl=document.getElementById("results-all");this.heuristicsEl=document.getElementById("heuristics");this.context=document.getElementById("canvas").getContext("2d");this.heuristics=this.solvers=this.state=this.level=void 0;this.solverIndex=0;this.advanceLevel(0);document.getElementById("next").onclick=this.advanceLevel.bind(this,
1);document.getElementById("prev").onclick=this.advanceLevel.bind(this,-1);document.getElementById("solve").onclick=this.solve.bind(this,void 0);document.getElementById("solve-all").onclick=this.solveAll.bind(this);document.getElementById("move").onclick=this.move.bind(this);document.addEventListener("keypress",this.onKeyPress.bind(this),!1)};
soko.Game.prototype.updateHeuristicsScores=function(){var a="";this.heuristics.forEach(function(b){a+=b[0]+" "+b[1].evaluate(this.state)+"<br>"}.bind(this));this.heuristicsEl.innerHTML=a};
soko.Game.prototype.advanceLevel=function(a){var b=soko.levelpacks;this.levelIndex+=a;0>this.levelIndex&&(this.levelPackIndex=(this.levelPackIndex-1+b.length)%b.length,this.levelIndex=b[this.levelPackIndex].levels.length-1);this.levelIndex>=b[this.levelPackIndex].levels.length&&(this.levelPackIndex=(this.levelPackIndex+1)%b.length,this.levelIndex=0);this.nameEl.innerHTML=b[this.levelPackIndex].name+" level:"+this.levelIndex;this.level=new soko.Level(b[this.levelPackIndex].levels[this.levelIndex]);
this.state=this.level.getInitialState();this.level.draw(this.state,this.context);this.solution=[];this.solvers=[];this.heuristics=[["Simple",new soko.heuristic.SimpleHeuristic(this.level)],["Better",new soko.heuristic.BetterHeuristic(this.level)],["Abstract",new soko.heuristic.AbstractHeuristic(this.level)]];this.resultsEl.innerHTML="";this.updateHeuristicsScores()};
soko.Game.prototype.solveSingle=function(a){if(this.solverIndex<this.solvers.length){var b=this.solvers[this.solverIndex][1].solve(this.level,this.state);0==this.solverIndex&&(this.solution=b,this.state=this.solution.pop())}var c="<table><thead><td>name</td><td>elapsed time</td><td>expanded</td><td>sol.length</td></thead>";this.solvers.forEach(function(a){c+="<tr><td>"+a[0]+"</td><td>"+a[1].solverStats.elapsedTime+"</td><td>"+a[1].solverStats.nodesVisited+"</td><td>"+a[1].solverStats.solutionLength+
"</td></tr>"});c+="</table>";this.resultsEl.innerHTML=c;this.solverIndex++;this.solverIndex<this.solvers.length?setTimeout(this.solveSingle.bind(this,a),1):a&&a()};
soko.Game.prototype.solve=function(a){if(void 0===this.solution||0==this.solution.length)this.solverIndex=0,this.solvers=[["abs+cond",new soko.Solver(soko.heuristic.AbstractHeuristic,soko.Heap,!0)],["abs",new soko.Solver(soko.heuristic.AbstractHeuristic,soko.Heap,!1)],["simple+cond",new soko.Solver(soko.heuristic.SimpleHeuristic,soko.Heap,!0)],["simple",new soko.Solver(soko.heuristic.SimpleHeuristic,soko.Heap)],["bfs+conde",new soko.Solver(soko.heuristic.NullHeuristic,soko.Heap,!0)],["bfs",new soko.Solver]],
this.solveSingle(a)};soko.Game.prototype.solveAll=function(){function a(){var c="";""==b&&(c="<table><thead><tr>",this.solvers.forEach(function(a){c+="<td>"+a[0]+"</td>"}),c+="</tr></thead>");c+="<tr>";this.solvers.forEach(function(a){c+="<td>"+a[1].solverStats.elapsedTime+"</td>"});c+="</tr>";b+=c;this.allResultsEl.innerHTML=b;this.advanceLevel(1);(0<this.levelIndex||0<this.levelPackIndex)&&this.solve(a.bind(this))}var b="";this.solve(a.bind(this))};
soko.Game.prototype.move=function(){void 0!==this.solution&&0<this.solution.length&&(this.state=this.solution.pop(),this.updateHeuristicsScores(),this.level.draw(this.state,this.context))};
soko.Game.prototype.onKeyPress=function(a){var b=this.level;a=a.keyCode||a.charCode;if(49==a||50==a)this.advanceLevel(49==a?-1:1);119==a&&b.move(this.state,soko.constants.Directions.UP);97==a&&b.move(this.state,soko.constants.Directions.LEFT);100==a&&b.move(this.state,soko.constants.Directions.RIGHT);115==a&&b.move(this.state,soko.constants.Directions.DOWN);if(63==a){a=new soko.heuristic.InvalidMap(b);for(var c=1;c<b.grid.length-1;c++)for(var d=1;d<b.grid[c].length-1;d++)a.isInvalidPoint([d,c])&&
(this.level.grid[c][d]|=128)}this.updateHeuristicsScores();this.level.draw(this.state,this.context)};
