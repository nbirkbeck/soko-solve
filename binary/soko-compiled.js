var COMPILED=!0,goog=goog||{};goog.global=this;goog.DEBUG=!0;goog.LOCALE="en";goog.TRUSTED_SITE=!0;goog.provide=function(a){if(!COMPILED){if(goog.isProvided_(a))throw Error('Namespace "'+a+'" already declared.');delete goog.implicitNamespaces_[a];for(var b=a;(b=b.substring(0,b.lastIndexOf(".")))&&!goog.getObjectByName(b);)goog.implicitNamespaces_[b]=!0}goog.exportPath_(a)};
goog.setTestOnly=function(a){if(COMPILED&&!goog.DEBUG)throw a=a||"",Error("Importing test-only code into non-debug environment"+a?": "+a:".");};COMPILED||(goog.isProvided_=function(a){return!goog.implicitNamespaces_[a]&&!!goog.getObjectByName(a)},goog.implicitNamespaces_={});goog.exportPath_=function(a,b,c){a=a.split(".");c=c||goog.global;a[0]in c||!c.execScript||c.execScript("var "+a[0]);for(var d;a.length&&(d=a.shift());)!a.length&&goog.isDef(b)?c[d]=b:c=c[d]?c[d]:c[d]={}};
goog.getObjectByName=function(a,b){for(var c=a.split("."),d=b||goog.global,e;e=c.shift();)if(goog.isDefAndNotNull(d[e]))d=d[e];else return null;return d};goog.globalize=function(a,b){var c=b||goog.global,d;for(d in a)c[d]=a[d]};
goog.addDependency=function(a,b,c){if(!COMPILED){var d;a=a.replace(/\\/g,"/");for(var e=goog.dependencies_,g=0;d=b[g];g++)e.nameToPath[d]=a,a in e.pathToNames||(e.pathToNames[a]={}),e.pathToNames[a][d]=!0;for(d=0;b=c[d];d++)a in e.requires||(e.requires[a]={}),e.requires[a][b]=!0}};goog.ENABLE_DEBUG_LOADER=!0;
goog.require=function(a){if(!COMPILED&&!goog.isProvided_(a)){if(goog.ENABLE_DEBUG_LOADER){var b=goog.getPathFromDeps_(a);if(b){goog.included_[b]=!0;goog.writeScripts_();return}}a="goog.require could not find: "+a;goog.global.console&&goog.global.console.error(a);throw Error(a);}};goog.basePath="";goog.nullFunction=function(){};goog.identityFunction=function(a,b){return a};goog.abstractMethod=function(){throw Error("unimplemented abstract method");};
goog.addSingletonGetter=function(a){a.getInstance=function(){if(a.instance_)return a.instance_;goog.DEBUG&&(goog.instantiatedSingletons_[goog.instantiatedSingletons_.length]=a);return a.instance_=new a}};goog.instantiatedSingletons_=[];
!COMPILED&&goog.ENABLE_DEBUG_LOADER&&(goog.included_={},goog.dependencies_={pathToNames:{},nameToPath:{},requires:{},visited:{},written:{}},goog.inHtmlDocument_=function(){var a=goog.global.document;return"undefined"!=typeof a&&"write"in a},goog.findBasePath_=function(){if(goog.global.CLOSURE_BASE_PATH)goog.basePath=goog.global.CLOSURE_BASE_PATH;else if(goog.inHtmlDocument_())for(var a=goog.global.document.getElementsByTagName("script"),b=a.length-1;0<=b;--b){var c=a[b].src,d=c.lastIndexOf("?"),d=
-1==d?c.length:d;if("base.js"==c.substr(d-7,7)){goog.basePath=c.substr(0,d-7);break}}},goog.importScript_=function(a){var b=goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_;!goog.dependencies_.written[a]&&b(a)&&(goog.dependencies_.written[a]=!0)},goog.writeScriptTag_=function(a){if(goog.inHtmlDocument_()){var b=goog.global.document;if("complete"==b.readyState){if(/\bdeps.js$/.test(a))return!1;throw Error('Cannot write "'+a+'" after document load');}b.write('<script type="text/javascript" src="'+
a+'">\x3c/script>');return!0}return!1},goog.writeScripts_=function(){function a(e){if(!(e in d.written)){if(!(e in d.visited)&&(d.visited[e]=!0,e in d.requires))for(var f in d.requires[e])if(!goog.isProvided_(f))if(f in d.nameToPath)a(d.nameToPath[f]);else throw Error("Undefined nameToPath for "+f);e in c||(c[e]=!0,b.push(e))}}var b=[],c={},d=goog.dependencies_,e;for(e in goog.included_)d.written[e]||a(e);for(e=0;e<b.length;e++)if(b[e])goog.importScript_(goog.basePath+b[e]);else throw Error("Undefined script input");
},goog.getPathFromDeps_=function(a){return a in goog.dependencies_.nameToPath?goog.dependencies_.nameToPath[a]:null},goog.findBasePath_(),goog.global.CLOSURE_NO_DEPS||goog.importScript_(goog.basePath+"deps.js"));
goog.typeOf=function(a){var b=typeof a;if("object"==b)if(a){if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else return"null";
else if("function"==b&&"undefined"==typeof a.call)return"object";return b};goog.isDef=function(a){return void 0!==a};goog.isNull=function(a){return null===a};goog.isDefAndNotNull=function(a){return null!=a};goog.isArray=function(a){return"array"==goog.typeOf(a)};goog.isArrayLike=function(a){var b=goog.typeOf(a);return"array"==b||"object"==b&&"number"==typeof a.length};goog.isDateLike=function(a){return goog.isObject(a)&&"function"==typeof a.getFullYear};goog.isString=function(a){return"string"==typeof a};
goog.isBoolean=function(a){return"boolean"==typeof a};goog.isNumber=function(a){return"number"==typeof a};goog.isFunction=function(a){return"function"==goog.typeOf(a)};goog.isObject=function(a){var b=typeof a;return"object"==b&&null!=a||"function"==b};goog.getUid=function(a){return a[goog.UID_PROPERTY_]||(a[goog.UID_PROPERTY_]=++goog.uidCounter_)};goog.removeUid=function(a){"removeAttribute"in a&&a.removeAttribute(goog.UID_PROPERTY_);try{delete a[goog.UID_PROPERTY_]}catch(b){}};
goog.UID_PROPERTY_="closure_uid_"+(1E9*Math.random()>>>0);goog.uidCounter_=0;goog.getHashCode=goog.getUid;goog.removeHashCode=goog.removeUid;goog.cloneObject=function(a){var b=goog.typeOf(a);if("object"==b||"array"==b){if(a.clone)return a.clone();var b="array"==b?[]:{},c;for(c in a)b[c]=goog.cloneObject(a[c]);return b}return a};goog.bindNative_=function(a,b,c){return a.call.apply(a.bind,arguments)};
goog.bindJs_=function(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}};goog.bind=function(a,b,c){Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_;return goog.bind.apply(null,arguments)};
goog.partial=function(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=Array.prototype.slice.call(arguments);b.unshift.apply(b,c);return a.apply(this,b)}};goog.mixin=function(a,b){for(var c in b)a[c]=b[c]};goog.now=goog.TRUSTED_SITE&&Date.now||function(){return+new Date};
goog.globalEval=function(a){if(goog.global.execScript)goog.global.execScript(a,"JavaScript");else if(goog.global.eval)if(null==goog.evalWorksForGlobals_&&(goog.global.eval("var _et_ = 1;"),"undefined"!=typeof goog.global._et_?(delete goog.global._et_,goog.evalWorksForGlobals_=!0):goog.evalWorksForGlobals_=!1),goog.evalWorksForGlobals_)goog.global.eval(a);else{var b=goog.global.document,c=b.createElement("script");c.type="text/javascript";c.defer=!1;c.appendChild(b.createTextNode(a));b.body.appendChild(c);
b.body.removeChild(c)}else throw Error("goog.globalEval not available");};goog.evalWorksForGlobals_=null;goog.getCssName=function(a,b){var c=function(a){return goog.cssNameMapping_[a]||a},d=function(a){a=a.split("-");for(var b=[],d=0;d<a.length;d++)b.push(c(a[d]));return b.join("-")},d=goog.cssNameMapping_?"BY_WHOLE"==goog.cssNameMappingStyle_?c:d:function(a){return a};return b?a+"-"+d(b):d(a)};goog.setCssNameMapping=function(a,b){goog.cssNameMapping_=a;goog.cssNameMappingStyle_=b};
!COMPILED&&goog.global.CLOSURE_CSS_NAME_MAPPING&&(goog.cssNameMapping_=goog.global.CLOSURE_CSS_NAME_MAPPING);goog.getMsg=function(a,b){var c=b||{},d;for(d in c){var e=(""+c[d]).replace(/\$/g,"$$$$");a=a.replace(RegExp("\\{\\$"+d+"\\}","gi"),e)}return a};goog.getMsgWithFallback=function(a,b){return a};goog.exportSymbol=function(a,b,c){goog.exportPath_(a,b,c)};goog.exportProperty=function(a,b,c){a[b]=c};
goog.inherits=function(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};
goog.base=function(a,b,c){var d=arguments.callee.caller;if(d.superClass_)return d.superClass_.constructor.apply(a,Array.prototype.slice.call(arguments,1));for(var e=Array.prototype.slice.call(arguments,2),g=!1,f=a.constructor;f;f=f.superClass_&&f.superClass_.constructor)if(f.prototype[b]===d)g=!0;else if(g)return f.prototype[b].apply(a,e);if(a[b]===d)return a.constructor.prototype[b].apply(a,e);throw Error("goog.base called from a method of one name to a method of a different name");};
goog.scope=function(a){a.call(goog.global)};var soko={HeapInterface:function(){}};soko.HeapInterface.prototype.size=function(){};soko.HeapInterface.prototype.empty=function(){};soko.HeapInterface.prototype.push=function(a,b){};soko.HeapInterface.prototype.pop=function(){};soko.Queue=function(){this.data_=[];this.map_=[]};soko.Queue.prototype.empty=function(){return 0==this.data_.length};soko.Queue.prototype.size=function(){return this.data_.length};soko.Queue.prototype.push=function(a,b){this.map_[a.id]=this.data_.length;this.data_.push([a,b])};soko.Queue.prototype.pop=function(){var a=this.data_.shift();this.map_[a[0].id]=void 0;return{value:a[0],score:a[1]}};soko.Queue.prototype.exists=function(a){return void 0!==this.map_[a.id]};
soko.Queue.prototype.updateIfBetter=function(a,b){};soko.types={};soko.State=function(a,b){this.pos=[a[0],a[1]];this.boxes=b.map(function(a){return a})};soko.State.MAX_WIDTH=8;soko.State.NBITS=6;soko.State.pointToIndex=function(a){return(a[1]-1)*soko.State.MAX_WIDTH+(a[0]-1)};soko.State.prototype.createAbstraction=function(a,b){return new soko.State(this.pos,this.boxes.slice(a,b))};
soko.State.prototype.pack=function(){for(var a=this.boxes.sort(function(a,b){return soko.State.pointToIndex(b)-soko.State.pointToIndex(a)}),b=soko.State.pointToIndex(this.pos),c=Math.min(a.length,4),d=0;d<c;d++)b+=soko.State.pointToIndex(a[d])<<(d+1)*soko.State.NBITS;if(4>=a.length)return b;for(var e=b.toString(16),b=0,d=c;d<a.length;++d)b+=soko.State.pointToIndex(a[d])<<(d-c)*soko.State.NBITS;return e+","+b.toString(16)};
soko.State.prototype.getBlockIndex=function(a){for(var b=0;b<this.boxes.length;b++)if(this.boxes[b][0]==a[0]&&this.boxes[b][1]==a[1])return b;return-1};soko.State.prototype.id=function(){return this.pack()};soko.Heap=function(){this.data_=[];this.map_={}};soko.Heap.prototype.size=function(){return this.data_.length};soko.Heap.prototype.empty=function(){return 0==this.data_.length};soko.Heap.prototype.push=function(a,b){var c=this.data_.length;this.data_[c]={score:b,value:a};this.map_[a.id]=c;this.siftUp_(c)};soko.Heap.prototype.pop=function(){this.swap_(0,this.data_.length-1);var a=this.data_[this.data_.length-1];this.data_.length--;this.map_[a.value.id]=void 0;this.siftDown_(0);return a};
soko.Heap.prototype.updateIfBetter=function(a,b){var c=this.map_[a.id];b<this.data_[c].score&&(this.data_[c].score=b,this.data_[c].value=a,this.siftUp_(c))};soko.Heap.prototype.exists=function(a){return void 0!==this.map_[a.id]};soko.Heap.prototype.siftDown_=function(a){for(var b=this.data_.length;2*a+1<b;){var c=2*a+1,d=2*a+2,e=d;if(d>=this.data_.length||this.data_[c].score<this.data_[d].score)e=c;if(this.data_[e].score<this.data_[a].score)this.swap_(e,a),a=e;else break}};
soko.Heap.prototype.siftUp_=function(a){for(;0<a;){var b=Math.floor((a-1)/2);if(this.data_[b].score>this.data_[a].score)this.swap_(b,a),a=b;else break}};soko.Heap.prototype.swap_=function(a,b){var c=this.data_[a];this.data_[a]=this.data_[b];this.data_[b]=c;this.map_[this.data_[a].value.id]=a;this.map_[this.data_[b].value.id]=b};soko.constants={};soko.constants.CellTypes={WALL:0,EMPTY:1,CROSS:2};soko.constants.Directions={UP:0,DOWN:1,LEFT:2,RIGHT:3};soko.constants.BLOCK_SIZE=32;soko.constants.MAX_CANVAS_BLOCKS=12;soko.constants.DELTAS=[[0,-1],[0,1],[-1,0],[1,0]];soko.Level=function(a){this.grid=[];this.startPos=[];this.boxes=[];this.crosses=[];this.maxWidth=0;a&&this.loadLevel(a)};
soko.Level.prototype.loadLevel=function(a){a=a.split("\n");this.grid=[];this.startPos=[];this.boxes=[];this.crosses=[];for(var b=this.maxWidth=0;b<a.length;++b){var c=[];if(0!=a[b].length){for(var d=0;d<a[b].length;++d){c[d]=soko.constants.CellTypes.EMPTY;"#"==a[b][d]&&(c[d]=soko.constants.CellTypes.WALL);if("x"==a[b][d]||"%"==a[b][d]||"@"==a[b][d])c[d]=soko.constants.CellTypes.CROSS,this.crosses.push([d,b]);if("*"==a[b][d]||"@"==a[b][d])this.startPos=[d,b],this.pos=[d,b];"b"!=a[b][d]&&"%"!=a[b][d]||
this.boxes.push([d,b])}this.maxWidth=Math.max(this.maxWidth,c.length);this.grid[b]=c}}};
soko.Level.prototype.draw=function(a,b){var c=soko.constants.BLOCK_SIZE;b.setTransform(1,0,0,1,0,0);b.fillStyle="#FFF";b.fillRect(0,0,1E3,1E3);b.translate((soko.constants.MAX_CANVAS_BLOCKS-this.maxWidth)/2*c,(soko.constants.MAX_CANVAS_BLOCKS-this.grid.length)/2*c);for(var d=0;d<this.grid.length;++d)for(var e=0;e<this.grid[d].length;++e)this.grid[d][e]==soko.constants.CellTypes.WALL?(b.fillStyle="#444",b.strokeStyle="#000",b.fillRect(e*c,d*c,c,c),b.strokeRect(e*c,d*c,c,c)):this.grid[d][e]==soko.constants.CellTypes.CROSS?
(b.strokeWidth=6,b.strokeStyle="#0F0",b.beginPath(),b.moveTo(e*c,(d+1)*c),b.lineTo((e+1)*c,d*c),b.moveTo(e*c,d*c),b.lineTo((e+1)*c,(d+1)*c),b.stroke()):4<this.grid[d][e]&&(b.strokeWidth=2,b.strokeStyle="#F00",b.beginPath(),b.moveTo(e*c+8,(d+1)*c-8),b.lineTo((e+1)*c-8,d*c+8),b.stroke());for(d=0;d<a.boxes.length;++d)e=a.boxes[d],b.fillStyle="#AA0",b.fillRect(e[0]*c,e[1]*c,c,c);b.beginPath();b.arc((a.pos[0]+0.5)*c,(a.pos[1]+0.5)*c,c/2,0,2*Math.PI);b.stroke()};
soko.Level.prototype.move=function(a,b){var c=soko.constants.DELTAS[b],d=soko.math.vectorAdd(a.pos,c),c=soko.math.vectorAdd(a.pos,c,2),e=this.getCellType(d),g=this.getCellType(c),f=a.getBlockIndex(d),h=a.getBlockIndex(c);if(e>=soko.constants.CellTypes.EMPTY){if(0>f)return a.pos=d,!0;if(g>=soko.constants.CellTypes.EMPTY&&0>h)return a.pos=d,a.boxes[f]=c,!0}return!1};soko.Level.prototype.getCellType=function(a){if(0<=a[1]&&a[1]<this.grid.length)return this.grid[a[1]][a[0]]};
soko.Level.prototype.getNeighbors=function(a){for(var b=[],c=0;4>c;++c){var d=new soko.State(a.pos,a.boxes);this.move(d,c)&&b.push([1,d])}return b};
soko.Level.prototype.computeShortestPath=function(a,b){var c={},d=[],e=[a.pos[0],a.pos[1],1,[]];c[soko.State.pointToIndex(e)]=1;for(d.push(e);0<d.length;){e=d.shift();if(b&&e[0]==b[0]&&e[1]==b[1]){c=[];do c.push([e[0],e[1]]),e=e[3];while(3<e.length);break}for(var g=0;4>g;++g){var f=soko.constants.DELTAS[g],f=[f[0]+e[0],f[1]+e[1],1+e[2],e],h=this.getCellType(f),k=a.getBlockIndex(f);h>=soko.constants.CellTypes.EMPTY&&0>k&&(h=soko.State.pointToIndex(f),void 0===c[h]&&(c[h]=f[2],d.push(f)))}}return c};
soko.Level.prototype.getNeighborsCondensed=function(a){for(var b=[],c=this.computeShortestPath(a),d=0;d<a.boxes.length;++d)for(var e=a.boxes[d],g=0;4>g;++g){var f=soko.constants.DELTAS[g],h=soko.math.vectorAdd(e,f);if(!(this.getCellType(h)<soko.constants.CellTypes.EMPTY||0<=a.getBlockIndex(h)||(f=soko.math.vectorAdd(e,f,-1),this.getCellType(f)<soko.constants.CellTypes.EMPTY))){var k=c[soko.State.pointToIndex(f)];if(void 0!==k){var p=new soko.State(e,a.boxes);p.boxes[d]=h;b.push([k,p,f])}}}return b};
soko.Level.prototype.isGoal=function(a){for(var b=0;b<a.boxes.length;++b)if(this.getCellType(a.boxes[b])!=soko.constants.CellTypes.CROSS)return!1;return!0};soko.Level.prototype.getInitialState=function(){return new soko.State(this.startPos,this.boxes)};soko.Level.prototype.createAbstraction=function(a,b){var c=new soko.Level;c.grid=this.grid;c.startPos=this.startPos;c.crosses=this.crosses;c.boxes=[];for(var d=a;d<b;d++)c.boxes.push(this.boxes[d].slice(0,2));return c};soko.math={};soko.math.vectorAdd=function(a,b,c){c=c||1;return[a[0]+b[0]*c,a[1]+b[1]*c]};soko.math.vectorDistanceL1=function(a,b){return Math.abs(a[0]-b[0])+Math.abs(a[1]-b[1])};soko.math.factorial=function(a){for(var b=1;1<a;)b*=a,--a;return b};soko.heuristic={};soko.heurisitc={};soko.heurisitc.SimplelHeuristic={};soko.heurisitc.AbstractHeuristic={};soko.heuristic.MAX_SCORE=1E4;
soko.heuristic.InvalidMap=function(a){this.map_={};for(var b=1;b<a.grid.length-1;++b)for(var c=1;c<a.grid[b].length-1;++c){var d=[c,b],e=a.getCellType(d);if(e!=soko.constants.CellTypes.CROSS&&e!=soko.constants.CellTypes.WALL){var e=soko.State.pointToIndex(d),g=a.getCellType([d[0],d[1]-1])==soko.constants.CellTypes.WALL,f=a.getCellType([d[0],d[1]+1])==soko.constants.CellTypes.WALL,h=a.getCellType([d[0]-1,d[1]])==soko.constants.CellTypes.WALL,k=a.getCellType([d[0]+1,d[1]])==soko.constants.CellTypes.WALL;
(h||k)&&(g||f)&&(this.map_[e]=!0);(g||f)&&h&&this.tryMarkLine_(a,d,0,[0,g?-1:1]);(k||h)&&g&&this.tryMarkLine_(a,d,1,[h?-1:1,0])}}};
soko.heuristic.InvalidMap.prototype.tryMarkLine_=function(a,b,c,d){for(var e=0==c?a.grid[b[1]].length-1:a.grid.length-1,g=[b[0],b[1]],f=b[c]+1;f<e;++f){g[c]=f;var h=a.getCellType(g);if(h==soko.constants.CellTypes.WALL){e=f;break}var k=soko.math.vectorAdd(g,d),k=a.getCellType(k)>=soko.constants.CellTypes.EMPTY;if(h==soko.constants.CellTypes.CROSS||k)return}g=[b[0],b[1]];for(f=b[c]+1;f<e;++f)g[c]=f,this.map_[soko.State.pointToIndex(g)]=!0};
soko.heuristic.InvalidMap.prototype.isInvalid=function(a){for(var b=0;b<a.boxes.length;++b)if(this.isInvalidPoint(a.boxes[b]))return!0;return!1};soko.heuristic.InvalidMap.prototype.isInvalidPoint=function(a){return this.map_[soko.State.pointToIndex(a)]};soko.heuristic.Heuristic=function(){};soko.heuristic.Heuristic.prototype.evaluate=function(a){};soko.heuristic.NullHeuristic=function(a){};soko.heuristic.NullHeuristic.prototype.evaluate=function(a){return 0};
soko.heuristic.SimpleHeuristic=function(a){this.level_=a;this.invalidMap_=new soko.heuristic.InvalidMap(a)};soko.heuristic.SimpleHeuristic.prototype.evaluate=function(a){for(var b=0,c=soko.heuristic.MAX_SCORE,d=this.level_,e=0;e<a.boxes.length;++e){for(var g=1E10,f=a.boxes[e],h=0,k=d.crosses.length;h<k;++h)g=Math.min(g,soko.math.vectorDistanceL1(d.crosses[h],f));b+=g;c=Math.min(soko.math.vectorDistanceL1(f,a.pos),c)}return b+Math.max(0,c-1)};
soko.heuristic.BetterHeuristic=function(a){this.level=a;this.invalidMap_=new soko.heuristic.InvalidMap(a)};
soko.heuristic.BetterHeuristic.prototype.evaluate=function(a){if(4<a.boxes.length)return 0;var b=soko.math.factorial(a.boxes.length),c=1E10;if(this.invalidMap_.isInvalid(a))return soko.heuristic.MAX_SCORE;for(var d=0;d<b;++d){for(var e=d,g=[],f=[],h=0,k=0;k<a.boxes.length;++k){for(var p=a.boxes.length-k,s=e%p,l=0;0<s||!0===g[l];)!0!==g[l]&&s--,l++;s=soko.math.vectorDistanceL1(this.level.crosses[l],a.boxes[k]);e=Math.floor(e/p);h+=s;g[l]=!0;f[k]=s}f=f.sort();for(l=0;l<f.length-1;++l)h+=f[l];c=Math.min(h,
c)}b=soko.heuristic.MAX_SCORE;for(d=0;d<a.boxes.length;++d)b=Math.min(soko.math.vectorDistanceL1(a.boxes[d],a.pos),b);return c+Math.max(0,b-1)};
soko.heuristic.AbstractHeuristic=function(a,b){this.level_=a;this.abstractLevels_=[];this.cache_={};this.abstractionSize_=b||1;for(var c=0;c<a.boxes.length;c+=this.abstractionSize_)this.abstractLevels_.push(a.createAbstraction(c,Math.min(a.boxes.length,c+this.abstractionSize_)));this.solver_=1==this.abstractionSize_?new soko.Solver(soko.heuristic.SimpleHeuristic,soko.Heap):new soko.Solver(soko.heuristic.AbstractHeuristic,soko.Heap)};
soko.heuristic.AbstractHeuristic.prototype.evaluate=function(a){for(var b=0,c=0;c<this.abstractLevels_.length;c++){var d=this.abstractionSize_*c,e=Math.min(a.boxes.length,d+this.abstractionSize_),g=a.createAbstraction(d,e),e=g.id(),d=this.cache_[e];if(void 0===d)for(g=this.solver_.solve(this.abstractLevels_[c],g),d=g.length-1,0>d&&(d=soko.heuristic.MAX_SCORE),this.cache_[e]=d,e=0;e<g.length;e++)this.cache_[g[e].id()]=e;b=Math.max(b,d)}return b};
soko.heuristic.MaxHeuristic=function(a){this.heuristics_=[new soko.heuristic.AbstractHeuristic(a),new soko.heuristic.AbstractHeuristic(a,2),new soko.heuristic.BetterHeuristic(a),new soko.heuristic.SimpleHeuristic(a)]};soko.heuristic.MaxHeuristic.prototype.evaluate=function(a){var b=0;this.heuristics_.forEach(function(c){b=Math.max(c.evaluate(a),b)});return b};soko.Solver=function(a,b,c){this.heuristicType_=a||soko.heuristic.NullHeuristic;this.heapType_=b||soko.Queue;this.condensed_=c||!1;this.print=!1;this.solverStats={elapsedTime:"",solutionLength:"",finalQueueSize:"",nodesVisited:""}};
soko.Solver.prototype.solve=function(a,b){var c=[],d=Date.now(),e=new this.heuristicType_(a),g={state:b,g:0,h:e.evaluate(b),parent:null,id:b.id()},f=new this.heapType_,h=0,k={},p=a.getNeighbors.bind(a),s=new soko.heuristic.InvalidMap(a);this.condensed_&&(p=a.getNeighborsCondensed.bind(a));for(f.push(g,g.h);!f.empty();){var l=f.pop(),g=l.value;this.print&&0==h%5E3&&console.log(l.score+" "+h+" "+f.size());if(0==h%2E4&&60<(Date.now()-d)/1E3)break;k[g.id]=!0;h++;if(a.isGoal(g.state)){c=this.backtrack_(a,
g);break}for(var l=p(g.state),q=0,m=l.length;q<m;++q){var n=l[q][1].id();if(!k[n]&&!s.isInvalid(l[q][1])){var r=l[q][1],u=g.g+l[q][0],t=e.evaluate(r),v=u+t,n={state:r,pusher:l[q][2],g:u,h:t,parent:g,id:n};f.exists(n)?f.updateIfBetter(n,v):f.push(n,v)}}}d=(Date.now()-d)/1E3;this.print&&console.log("numVisited:"+h+" duration:"+d);this.solverStats={solutionLength:c.length,elapsedTime:d,finalQueueSize:f.size(),nodesVisited:h};return c};
soko.Solver.prototype.backtrack_=function(a,b){var c=[];this.print&&console.log(b);do{var d=b.parent;if(null!=d&&b.pusher){var e=a.computeShortestPath(d.state,b.pusher);c.push(b.state);for(var g=0;g<e.length-1;g++){var f=new soko.State(e[g],d.state.boxes);c.push(f)}}else c.push(b.state);b=b.parent}while(null!=b);this.print&&console.log(c.length);return c};soko.levels={};soko.levels.microa="#######\n#*  bx#\n#   bx#\n#######\n;########\n#x     #\n#  bb x#\n#*     #\n########\n;####\n# x#\n#  ###\n#%*  #\n#  b #\n#  ###\n####\n;######\n#    #\n# #* #\n# b% #\n# x% #\n#    #\n######\n;  ####   \n###  ####\n#     b #\n# #  #b #\n# x x#* #\n#########\n;########\n#      #\n# x%%b*#\n#      #\n#####  #\n    ####\n; #######\n #     #\n # xbx #\n## b*b #\n#  xbx #\n#      #\n########\n;#######\n#     #\n# xbx #\n# bxb #\n# xbx #\n# bxb #\n#  *  #\n#######\n;  ######\n  # xx*#\n  # bb #\n  ## ###\n#### #\n#    ##\n# #   #\n#   # #\n###   #\n  #####\n;#####\n#x  ##\n#*bb #\n##   #\n ##  #\n  ##x#\n   ###\n;  ###### \n  #    # \n  # ##*##\n### # b #\n# xx# b #\n#       #\n#  ######\n####\n;#####\n#   ##\n# b  #\n## b ####\n ###*x  #\n  #  x# #\n  #     #\n  #######\n;####\n#x ##\n#x* #\n#x b#\n##b ###\n # b  #\n #    #\n #  ###\n ####;#######\n#     #\n# # # #\n#x b%*#\n#   ###\n#####  \n;     ### \n######*##\n#    x% #\n#   #   #\n#####b# #\n    #   #\n    #####\n; #### \n #  ####\n #     ##\n## ## * #\n#x x#  b##\n#   # bb #\n#  x#    #\n##########\n;#####\n# * #\n#xxx#\n#bbb##\n#    #\n#    #\n######;#######\n#     #\n#x x  #\n# ## ##\n#  b #\n###b #\n  #* #\n  #  #\n  ####\n;########\n#   xx #\n#  *bb #\n##### ##\n   #  #\n   #  #\n   #  #\n   ####;#######\n#*    ###\n#   bbxx#\n#### ## #\n  #     #\n  #  ####\n  #  #\n  ####\n;####\n#  ####\n# x x #\n# bb#*#\n##    #\n ######;#####\n#   ###\n#x x  #\n#   # #\n## #  #\n #*bb #\n #    #\n #  ###\n ####\n;#######\n#  %  #\n#     #\n## # ##\n #b*x#\n #   #\n #####\n;  #####\n  #   #\n###bb*#\n#   ###\n#     #\n# x x #\n#######\n; ####\n #  ###\n # bb #\n##xxx #\n#  *b #\n#   ###\n#####\n; #####\n # * #\n #   #\n###b #\n# xxx#\n# bb #\n###  #\n  ####\n;######\n#   x#\n# ## ##\n#  bb*#\n# #   #\n#x  ###\n#####\n;#####\n#   #\n# * #\n# bb###\n##x x #\n #    #\n ######\n;####\n#  ###\n# bb #\n#xxx #\n# *b #\n#   ##\n#####;  ####\n ##  #\n##*bx##\n# bb  #\n# x x #\n###   #\n  #####\n".split(";");soko.levels.microc="  ####\n ##  #####\n #  b  * #\n #  b#   #\n#### #####\n#  #   #\n#    b #\n# xx#  #\n#  x####\n#  ##\n####;####\n#  #####\n# bb b #\n#      #\n## ## ##\n#xxx#*#\n# ### ##\n#      #\n#  #   #\n########\n; #######\n## xxxx#\n#   ######\n#   b b *#\n###  b b #\n  ###    #\n    ######\n; #####\n##   #\n#    #####\n#  #x#   #\n#* #x# b #\n#  #x#  ##\n#    #  #\n##  ##bb#\n ##     #\n  #  ####\n  ####\n; #########\n #    #  #\n## b#b#  #\n#  xbx*  #\n#  x#    #\n##########\n;####\n#  #######\n#  x ## x#\n# b#    x#\n## ## # x#\n #    #  #\n #### #  #\n  # *b ###\n  # bb #\n  #    #\n  ######; #####\n #   #\n # x #\n## % #\n#  %##\n#  *##\n## b #\n #   #\n #####\n;#####\n#   ###\n# x   ##\n##%#b  #\n# x# b #\n# *## ##\n#      #\n########\n;######  \n#    ##  \n# b b ## \n## bb  # \n # #   # \n # ## ## \n #  x x# \n # *x x# \n #  #### \n ####    \n;    #### \n  ###  ##\n ## b   #\n## b  # #\n# *#bb  #\n# xx  ###\n# xx###\n#####\n;     ####\n######  #\n#       #\n#  xxx x#\n##b######\n# b  #\n#   b###\n##  b  #\n ## *  #\n  ######\n;##########\n#   ##   #\n# b  b*# #\n#### # b #\n   #x#  ##\n   #x# b#\n   #x   #\n   #x   #\n   ######\n; ########\n #  *   #\n # b  b #\n### ## ###\n#  bxxb  #\n#   xx   #\n##########\n;#########\n# * #   #\n# b b   #\n##b### ##\n#  xxx  #\n#   #   #\n######  #\n     ####\n;########\n#*     #\n# xbbx #\n# bxxb #\n# bxxb #\n# xbbx #\n#      #\n########\n;#######\n# *#  #\n#xb   #\n#x # b##\n#xb#   #\n#x # b #\n#  #   #\n########\n;  #####\n  # x ##\n### b  #\n# x b#*#\n# #b x #\n#  b ###\n## x #\n #####\n;    #####\n#####   #\n#    b  #\n#  b#b#*#\n### #   #\n  # xxx #\n  ###  ##\n    #  #\n    ####\n; ########\n #      #\n #*   b #\n## ###b #\n# xxxxx###\n# b b b  #\n###### # #\n     #   #\n     #####\n;########\n#      #\n# b%%% #\n# %  % #\n# %  % #\n# %%%x #\n#     *#\n########\n;  ####\n  #  #\n  # b####\n###x x  #\n# b # b #\n#  x x###\n####b #\n   # *#\n   ####\n;######\n#    ####\n#    xxx#\n#    xxx#\n######  #\n  #  #  #\n  # bb ##\n  # *b  #\n  # bb  #\n  ## b# #\n   #    #\n   ######\n".split(";");var levelpacks=[{name:"microa",levels:soko.levels.microa},{name:"microc",levels:soko.levels.microc}];
soko.game=function(){function a(){var a="";u.forEach(function(b){a+=b[0]+" "+b[1].evaluate(n)+"<br>"});l.innerHTML=a}function b(b){g+=b;0>g&&(e=(e-1+levelpacks.length)%levelpacks.length,g=levelpacks[e].levels.length-1);g>=levelpacks[e].levels.length&&(e=(e+1)%levelpacks.length,g=0);k.innerHTML=levelpacks[e].name+" level:"+g;m=new soko.Level(levelpacks[e].levels[g]);n=m.getInitialState();m.draw(n,q);f=[];r=[];u=[["Simple",new soko.heuristic.SimpleHeuristic(m)],["Better",new soko.heuristic.BetterHeuristic(m)],
["Abstract",new soko.heuristic.AbstractHeuristic(m)]];p.innerHTML="";a()}function c(a){if(t<r.length){var b=r[t][1].solve(m,n);0==t&&(f=b,n=f.pop())}var d="<table><thead><td>name</td><td>elapsed time</td><td>expanded</td><td>sol.length</td></thead>";r.forEach(function(a){d+="<tr><td>"+a[0]+"</td><td>"+a[1].solverStats.elapsedTime+"</td><td>"+a[1].solverStats.nodesVisited+"</td><td>"+a[1].solverStats.solutionLength+"</td></tr>"});d+="</table>";p.innerHTML=d;t++;t<r.length?setTimeout(c.bind(this,a),
1):a&&a()}function d(a){if(void 0===f||0==f.length)t=0,r=[["abs+cond",new soko.Solver(soko.heuristic.AbstractHeuristic,soko.Heap,!0)],["abs",new soko.Solver(soko.heuristic.AbstractHeuristic,soko.Heap,!1)],["simple+cond",new soko.Solver(soko.heuristic.SimpleHeuristic,soko.Heap,!0)],["simple",new soko.Solver(soko.heuristic.SimpleHeuristic,soko.Heap)],["bfs+conde",new soko.Solver(soko.heuristic.NullHeuristic,soko.Heap,!0)],["bfs",new soko.Solver]],c(a)}var e=0,g=0,f,h=soko.constants,k=document.getElementById("name"),
p=document.getElementById("results"),s=document.getElementById("results-all"),l=document.getElementById("heuristics"),q=document.getElementById("canvas").getContext("2d"),m,n,r,u,t=0;b(0);document.getElementById("next").onclick=b.bind(window,1);document.getElementById("prev").onclick=b.bind(window,-1);document.getElementById("solve").onclick=function(){d(void 0)};document.getElementById("solve-all").onclick=function(){function a(){var f="";""==c&&(f="<table><thead><tr>",r.forEach(function(a){f+="<td>"+
a[0]+"</td>"}),f+="</tr></thead>");f+="<tr>";r.forEach(function(a){f+="<td>"+a[1].solverStats.elapsedTime+"</td>"});f+="</tr>";c+=f;s.innerHTML=c;b(1);(0<g||0<e)&&d(a)}var c="";d(a)};document.getElementById("move").onclick=function(){void 0!==f&&0<f.length&&(n=f.pop(),a(),m.draw(n,q))};document.addEventListener("keypress",function(c){c=c.keyCode||c.charCode;49!=c&&50!=c||b(49==c?-1:1);119==c&&m.move(n,h.Directions.UP);97==c&&m.move(n,h.Directions.LEFT);100==c&&m.move(n,h.Directions.RIGHT);115==c&&
m.move(n,h.Directions.DOWN);if(63==c){c=new soko.heuristic.InvalidMap(m);for(var d=1;d<m.grid.length-1;d++)for(var e=1;e<m.grid[d].length-1;e++)c.isInvalidPoint([e,d])&&(m.grid[d][e]|=128)}a();m.draw(n,q)},!1)};goog.exportSymbol("soko.game",soko.game);
